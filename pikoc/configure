#!/bin/bash

if [ ! $# == 1 ]
then
	echo "Usage: configure [Linux | Windows]"
	exit
fi

OS=$1

# Create pikocPaths.in for the user to specify paths to CUDA and LLVM
if [ ! -e pikocPaths.in ]
then
	if [ $OS == "Windows" ]
	then
		echo "CUDA_PATH = C:/Program\ Files/NVIDIA\ GPU\ Computing\ Toolkit/CUDA/v6.0" >> pikocPaths.in
		echo "LLVM_INSTALL_PATH = E:/llvm/llvm-3.2" >> pikocPaths.in
		echo "LLVM_SRC_PATH = E:/llvm/llvm-3.2/src" >> pikocPaths.in
	else
		echo "CUDA_PATH = /usr/local/cuda" >> pikocPaths.in
		echo "LLVM_INSTALL_PATH = /usr/local/llvm/llvm-3.2" >> pikocPaths.in
		echo "LLVM_SRC_PATH = /usr/local/llvm/llvm-3.2/src" >> pikocPaths.in
	fi
fi

echo "Edit pikocPaths.in then press ENTER to continue..."

read

# Generate the Makefile
echo "# Automatically generated by the configure script.  Do not edit!  Changes will be lost!" > Makefile
echo "" >> Makefile
cat pikocPaths.in >> Makefile
echo "" >> Makefile
echo "NVVM_PATH = \$(CUDA_PATH)/nvvm" >> Makefile
echo "" >> Makefile

if [ $OS == "Windows" ]
then
	echo "CXX = g++" >> Makefile
	echo "" >> Makefile
	echo "LIBS = -limagehlp -lpsapi" >> Makefile
	echo "NVVM_LIB_PATH = \$(NVVM_PATH)/lib/Win32" >> Makefile
	echo "" >> Makefile
else
	echo "CXX = \$(LLVM_INSTALL_PATH)/bin/clang++" >> Makefile
	echo "" >> Makefile
	echo "LIBS = " >> Makefile
	echo "NVVM_LIB_PATH = \$(NVVM_PATH)/lib64" >> Makefile
	echo "" >> Makefile
fi

cat Makefile.in >> Makefile

# Generate the file that tells pikoc the paths to CUDA and to the Piko API
read tmp1 tmp2 PIKOC_CUDA_PATH < pikocPaths.in

line=$(sed '2q;d' pikocPaths.in)
read tmp1 tmp2 PIKOC_LLVM_PATH <<< $line

echo "// Automatically generated by the configure script.  Do not edit!  Changes will be lost!" > src/PikocOptions.in
echo "" >> src/PikocOptions.in
echo "#define CLANG_RESOURCE_PATH" \"$PIKOC_LLVM_PATH"/lib/clang/6.0.0/include"\" >> src/PikocOptions.in
echo "#define CUDA_INCLUDE_PATH" \"$PIKOC_CUDA_PATH"/include"\" >> src/PikocOptions.in
echo -n "#define PIKOC_API_PATH \"" >> src/PikocOptions.in
cd api/include
if [ $OS == "Windows" ]
then
	pwd | cut -c 2-2 | tr -d '\n' >> ../../src/PikocOptions.in
	echo -n ":/" >> ../../src/PikocOptions.in
	pwd | cut -c 4- | tr -d '\n' >> ../../src/PikocOptions.in
else
	pwd | tr -d '\n' >> ../../src/PikocOptions.in
fi

cd ../..
echo \" >> src/PikocOptions.in
echo "" >> src/PikocOptions.in

if [ $OS == "Windows" ]
then
	echo "#define OS_STRING \"mingw32\"" >> src/PikocOptions.in
else
	echo "#define OS_STRING \"\"" >> src/PikocOptions.in
fi
